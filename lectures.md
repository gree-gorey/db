# Базы данных

## Содержание
* [13.09.2016<br>Проектирование БД](#13092016Проектирование-БД)
* [15.11.2016<br>Работа с таблицами SQL](#15112016Работа-с-таблицами-sql)
* [06.12.2016<br>Работа с таблицами SQL](#06122016Многопользовательский-режим)

## 13.09.2016<br>Проектирование БД

* анализ предметной области
    * текстовое описание
* создание модели предметной области
    * как сущности связаны между собой
* создание модели БД
* создание БД

## 15.11.2016<br>Работа с таблицами SQL

### Пример БД студентов
Students(id, name, group)<br>
Grades(student, grade)<br>
Groups(id, number)<br>

#### Запросы
Найти максимальную оценку:
```
SELECT GRADE
FROM GRADES
ORDER BY GRADE DESC
LIMIT 1;
```
или то же самое другим способом:
```
SELECT MAX(GRADE)
FROM GRADES;
```

```
SELECT *
FROM GRADES
JOIN STUDENTS
ON student = STUDENTS.id;
```
Результат -- R(#student, grade, name, group)

```
SELECT MAX(GRADE) group
FROM GRADES
JOIN STUDENTS
ON student = STUDENTS.id
GROUP BY group;
```
Выбрать пары студент -- название группы
```
SELECT NAME, Number
FROM STUDENTS
JOIN GROUPS
ON group = groups.id;
```
Выбрать студентов, у которых оченки ниже средней
```
SELECT *
FROM STUDENTS
JOIN GRADES
ON id = student;
WHERE grade >
    ( SELECT AVG(grade)
       FROM GRADES );
```
Найти студентов с заданным именем
```
SELECT *
FROM GRADES
WHERE name LIKE '%Николай%';
```

## 06.12.2016<br>Многопользовательский режим

### Коллизии одновременного доступа:

1) последнего изменения. *Бронирование авиабилетов. Одновременно на одно место*
2) "грязное" чтение. *Перевод денег. Уже списали, но еще не записали*
3) неповторяемое чтение. *Версии данных могут меняться пока мы с работаем с БД*
4) фантомное чтение. *Кто-то удаляет строки из таблицы*

### Борьба с коллизиями

Для борьбы базы данных реализуют **блокировки** и **транзакции**.
Блокировки двух видов:

* на чтение, *read block*
* на запись, *write block*

**Блокировка** – это ограничение на операции по обработке данных.

**Транзакция** – это логическая единица работы в БД.
Транзакция переводит БД из одного непротиворечивого состояния в другое.
Транзакия может содержать несколько операций по работе с БД.
Все операции, входящие в транзакцию, либо выполняются успешно, либо восстанавливается состояние БД до начала транзакций.
Транзакция реализует два механизма:

* откат, *rollback*, реализуется если какая-то из операций не может быть выполнена
* фиксацию, *commit*, сохраняет изменения в БД

Для организации многопользовательского режима транзакции используют блокировки.
При *блокировке записи* транзакция блокирует записи в БД таким образом, что любой другой запрос будет отменен.
При *блокировке чтения* блокирует таким образом, что запрос другой транзакции на блокировку записи этих строк будет отвергнут, а запрос на чтение будет разрешен.

СУБД использует следующий протокол:

1) транзакция, которая читает данные из строки, обязана наложить на строку блоктровку чтения
2) транзакция, в рамках которой модифицируется строка, обяана наложить на нее блокировку записи
3) если запрашиваемая блокировка на строку отвергается из-за уже имеющейся блокировки, то транзакция переводится в режим ожидания до тех пор пока блокировка не освободится
4) блокировка записи сохраняется вплоть до конца транзакции

**ACID**

* Атомарность, *atomicity*. Видим состояние БД либо до транзакции, либо после.
* Согласованность, *consistency*. БД всегда в согласованном состоянии.
* Изоляция, *isolation*. Транзакия не зависит от других транзакций.
* Надежность, *durability*. Если все операции транзакции успешны, то изменения записываются в БД.

4 уровня блокировки в БД (изоляции транзакций):

0) запрет на загрязнение данных. Требуется, чтобы изменять данные могла только одна транзакция
1) запрет грязного чтения. Если транзакция начала изменять данные, то другая не может их прочитать
2) запрет неповторяемого чтения. Если транзакция считывает данные, то никакая другая не может их изменить
3) запрет фантомов. Если транзакция обращается к данным, то никакая другая транзакция не может удалять или добавлять строки, которые могут быть считаны при проведении транзакции


